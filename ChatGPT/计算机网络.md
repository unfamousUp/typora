## 网络通信过程

1. 应用层:应用程序通过调用socket()函数创建套接字,然后通过connect()向服务器的 IP地址和端口连接。调用send()函数,通过套接字发送数据,这些系统调用将数据从应用程序空间复制到内核缓冲区。
2. 传输层:TCP模块收到数据后,先检查连接状态,然后将数据流划分为多个报文段。添加TCP头,包含源端口号和目标端口号(表示应用进程)、序号(用于重组报文)、标志位ACK/SYN/FIN/RST等控制信息、校验和、接收窗口大小等字段。形成完整的TCP报文段结构。
3. 网络层:IP模块获取到TCP报文段,提取出源IP和目标IP地址(标识主机),检查首部校验和。根据路由表计算出下一跳IP地址。在IP头部填充内容,包括版本号、首部长度、服务类型、总长度、标识、TTL、协议类型等。完成封装后,形成IPv4数据报结构。
4. 数据链路层:网卡驱动获取到IP数据报,根据ARP缓存中的IP到MAC地址映射,读取出目标MAC地址。构造以太网头,填充目标和源MAC地址、类型字段。添加CRC校验,形成完整以太网帧结构。通过DMA传输加载到网卡缓冲区等待发送。
5. 物理层:网卡的PHY芯片逐比特读取帧数据,先进行编码(如曼彻斯特编码),然后转换为电压信号的波形模式,载入载波中进行调制(如QAM),最后经过数字模拟转换,输出模拟电信号到传输介质。
6. 信号经过网络介质传播进入对端网卡,PHY芯片使用ADC进行模数转换,解调提取数字信号,进行解码还原比特流。
7. 解码后的比特流写入接收缓冲区,网卡驱动程序对比特流进行重新组装,检验CRC,过滤出完整的一帧并校验MAC地址。
8. 驱动程序将以太网头去除,过滤出IP数据报的内容部分,提交给网络层IP模块处理。
9. IP模块校验版本号、长度是否合法,去除IP头部,提取出TCP报文,通过查找端口映射提交给相应的TCP socket。
10. TCP模块检验校验和,序号是否连续,按序号重组报文,去除TCP首部,只保留Payload数据,返回给应用程序。
11. 应用程序接收到请求数据,进行应用层协议解析,完成请求。